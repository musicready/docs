---
title: "Working Set Envelope"
description: "A scoped MRS-S fragment with context rings and edit lane permissions for bounded agent operations on full-scale scores."
---

The Working Set Envelope is the core mechanism for enabling context-aware agent workflows. It wraps a bounded MRS-S fragment with scope metadata, context rings, **edit lane permissions**, and synopsis access.

See: [`/MRS-Specification-RFC#5-working-set-envelope`](/MRS-Specification-RFC#5-working-set-envelope)

## Key Principles

- **Agents receive valid MRS-S and return valid MRS-S**—no separate syntax
- **Scopes use UUIDs**—not measure numbers—for structural stability
- **Edit lanes define what can be modified**—disjoint lanes enable parallel work
- **Context rings** provide surrounding material at reduced detail
- **Scope negotiation** enables flexible conversational workflows

## Structure

```clojure
(working-set
  :version 1.0
  :source-hash "sha256:..."
  
  ;; === SCOPE: WHERE the agent may edit ===
  :scope
    (:measures #uuid "018c3f40-002d-..." #uuid "018c3f40-0034-...")
    (:parts [clarinet-1])
    (:voices [v1])  ; optional refinement
  :display-hint (:measures 45 52)  ; Informational only
  
  ;; === LANES: WHAT the agent may modify ===
  :lanes [notes expression]
  :allowed-ops [upsert-event delete-event upsert-span delete-span]
  
  ;; === LOCKS: What is read-only ===
  :locks
    ((structure :scope :all)           ; Form is locked
     (temporal :scope :all)            ; Tempo map is locked
     (harmonyPlan :measures #uuid "..." #uuid "..."))  ; Harmony locked for this section
  
  ;; === PRECONDITIONS: For conflict detection ===
  :base-revision "rev:abc123"
  :preconditions
    ((measure #uuid "018c3f40-002d-..." :hash "sha256:...")
     (measure #uuid "018c3f40-002e-..." :hash "sha256:..."))
  
  ;; === CONTEXT ===
  :context "Add countermelody to clarinet, following harmonic rhythm"
  
  :constraints
    ((range clarinet-1 E3 G6)
     (avoid parallel-fifths violin-1))
  
  ;; === CONTENT: Full-detail MRS-S (writable) ===
  :content
    (meta :time 4/4 :key C :mode minor)
    (parts ...)
    (measures ...)
    (spans ...)
  
  ;; === CONTEXT RINGS: Surrounding material (read-only) ===
  :context-near
    (:measures #uuid "..." #uuid "...")
    :reduction :melodic-skeleton
    :content (measures ...)
  
  :context-far
    (:measures #uuid "..." #uuid "...")
    :reduction :harmonic-rhythm
    :content (measures ...)
  
  :synopsis-ref "sha256:...")
```

## Scope Grant Schema

The scope grant is the intersection of **(where)** × **(what)** × **(how)**:

### WHERE: Region Targeting

```clojure
:scope
  (:measures #uuid "018c3f40-002d-..." #uuid "018c3f40-0034-...")
  (:parts [clarinet-1 clarinet-2])
  (:voices [v1])  ; optional
:display-hint (:measures 45 52)  ; Human-readable, never used structurally
```

- **Measures by UUID range** (inclusive)
- **Parts by ID** (explicit list)
- **Voices** (optional refinement)
- Display hints are informational only—never used for structural reference

### WHAT: Lane Permissions

```clojure
:lanes [notes expression]
```

Agents may only modify objects owned by their granted lanes:

| Lane | Owns |
|------|------|
| `structure` | Measure list, sections, repeats |
| `temporal` | Tempo map, time signatures |
| `harmonyPlan` | Chord symbols, harmonic rhythm |
| `notes` | Pitches, durations, rests, voices |
| `expression` | Dynamics, hairpins, slurs |
| `technique` | Articulations, playing techniques |
| `lyricsText` | Lyrics, syllables, underlay |

### HOW: Allowed Operations

```clojure
:allowed-ops [upsert-event delete-event upsert-span delete-span]
```

| Operation | Description |
|-----------|-------------|
| `upsert-event` | Create or update event by `:id` |
| `delete-event` | Remove event by `:id` |
| `upsert-span` | Create or update span by `:id` |
| `delete-span` | Remove span by `:id` |
| `set-attr` | Modify specific field (within lane) |

Structure operations (`insert-measures`, `delete-measures`) require explicit grant and typically trigger human review.

### Locks: Read-Only Constraints

```clojure
:locks
  ((structure :scope :all)
   (temporal :scope :all)
   (harmonyPlan :measures #uuid "..." #uuid "..."))
```

Locked lanes/regions are visible but not modifiable. Agents can read locked content for context.

## UUID-Based Scoping

All scope references use stable UUIDs:

```clojure
:scope
  (:measures #uuid "018c3f40-002d-..." #uuid "018c3f40-0034-...")
  (:parts [clarinet-1])
:display-hint (:measures 45 52)  ; Human-readable, never used structurally
```

Measure numbers appear ONLY in `:display-hint`—never for structural reference.

## Context Rings

Context rings provide surrounding material at graduated detail levels:

| Level | Content |
|-------|---------|
| `:full` | Everything (no reduction) |
| `:melodic-skeleton` | Downbeats, phrase boundaries, structural tones |
| `:harmonic-rhythm` | Chord roots, key changes, bass line |
| `:structural` | Rehearsal marks, tempo changes, texture shifts only |

All context ring content is **read-only**. Agents can read it but cannot modify it.

```clojure
:context-near
  (:measures #uuid "..." #uuid "...")
  :display-hint (:measures 41 44)
  :reduction :melodic-skeleton
  :content (measures ...)

:context-far
  (:measures #uuid "..." #uuid "...")
  :display-hint (:measures 1 40)
  :reduction :harmonic-rhythm
  :content (measures ...)
```

## Agent Response

Agents return a `working-set-response` containing valid MRS-S:

```clojure
(working-set-response
  :version 1.0
  :source-hash "sha256:..."  ; Must match request for conflict detection
  
  :scope
    (:measures #uuid "018c3f40-002d-..." #uuid "018c3f40-0034-...")
    (:parts [clarinet-1])
  :display-hint (:measures 45 52)
  
  :content
    (measures
      (measure 
        :id #uuid "018c3f40-002d-..."
        :number 45
        :beat-start 487+1/4
        (clarinet-1
          (v1
            (: 0 Eb4.q :dyn mp :id #uuid "018c3f50-..." :at 487+1/4)
            (: 1 D4.q :id #uuid "018c3f51-..." :at 488+1/4)
            (: 2 Eb4.e :id #uuid "018c3f52-..." :at 489+1/4)
            (: 2.5 F4.e :id #uuid "018c3f53-..." :at 489+3/4)
            (: 3 G4.q :id #uuid "018c3f54-..." :at 490+1/4))))
      ...)
    
    (spans
      (slur :id #uuid "018c3f55-..." 
            :from #uuid "018c3f50-..." 
            :to #uuid "018c3f54-..."))
  
  :rationale "Created contrary motion against violin line. Chord tones on downbeats.")
```

## Enforcement

When an agent returns a response, the orchestrator validates:

1. **Scope bounds**: All modified content is within declared scope
2. **Lane permissions**: All modifications are within granted lanes
3. **Allowed ops**: Only permitted operation types were used
4. **Lock compliance**: No locked regions/lanes were modified
5. **Preconditions**: Source hash and measure hashes match (conflict detection)

If validation fails:
- **Reject** the entire response, or
- **Strip** out-of-scope changes and apply valid changes (with warning)

## Scope Negotiation

Agents can request scope adjustments:

```clojure
(scope-request
  :reason "Phrase extends beyond current boundary"
  :current (:measures #uuid "..." #uuid "...")
  :requested (:measures #uuid "..." #uuid "...")
  :requested-lanes [notes expression]  ; May request additional lanes
  :justification "Slur endpoint at beat 487+3/4 in measure 56")
```

The orchestrator can:
- **Grant**: Provide expanded Working Set
- **Deny**: Return error with reason
- **Offer alternative**: Suggest different scope

```clojure
(scope-response
  :status :granted
  :scope
    (:measures #uuid "..." #uuid "...")
  :lanes [notes expression]
  :content ...)

; OR

(scope-response
  :status :denied
  :reason "Requested scope overlaps with active lock"
  :alternative
    (:measures #uuid "..." #uuid "..."))
```

## Self-Containment Principle

Every Working Set Envelope MUST be **self-contained**: the `:content` can be parsed and validated independently.

This means:
- Part definitions MUST be included
- Time/key/tempo state at extraction start MUST be declared
- Spans MUST have both endpoints within scope (or be marked with boundary markers)

See: [Extract-Replace Protocol](/extract-replace-protocol) for boundary span handling.

## Working with Draft States

Working Set Envelopes can include placeholders:

```clojure
:content
  (measures
    (measure :id #uuid "..."
      ;; Existing content
      (flute-1 (v1 (: 0 G5.q ...)))
      
      ;; Placeholder for agent to resolve
      (placeholder
        :id #uuid "..."
        :parts [violin-1 violin-2]
        :intent :accompaniment
        :description "String accompaniment, follow harmonic rhythm")))
```

The agent's task may be to resolve the placeholder with actual content.

See: [Draft States](/draft-states) for placeholder primitives and resolution.
